
# 8.Ünite - Trigger ve İstisna İşleme 

---

Veritabanı olaylarına otomatik tepki veren **Trigger (Tetikleyici)** mekanizmasını ve çalışma zamanı hatalarını yönetmeyi sağlayan **İstisna İşleme (Exception Handling)** yapısını ele almaktadır.

---

## BÖLÜM 1: Trigger (Tetikleyici)

Trigger, veritabanında gerçekleşen belirli bir olaya (INSERT, UPDATE, DELETE vb.) bağlı olarak, o olaydan önce (`BEFORE`) veya sonra (`AFTER`) sunucu tarafından **otomatik** olarak çalıştırılan özel prosedürlerdir.

### 1. Triggerların Özellikleri ve Kullanım Alanları

- **Otomatik Çalışma:** Prosedürler gibi kullanıcı tarafından manuel çağrılmazlar, tanımlandıkları olay gerçekleşince devreye girerler.
    
- **Yönetim:** `DISABLE` komutu ile geçici olarak durdurulabilir, `ENABLE` ile tekrar aktif edilebilirler.
    
- **Kullanım Alanları:**
    
    - Veri güvenliği ve denetimi (Auditing/Loglama).
        
    - Karmaşık veri bütünlüğü kontrolleri.
        
    - Otomatik değer atama (Örn: Doğum tarihinden yaş hesaplama).
        
    - Yetkisiz erişimi engelleme (Örn: Mesai saatleri dışında işlem yasağı).
        

### 2. Trigger Türleri ve Bileşenleri

- **DML Triggerları:** Tablo üzerinde veri değişikliği (`INSERT`, `UPDATE`, `DELETE`) yapıldığında çalışır.
    
    - **Deyim Seviyesi (Statement Level):** İşlemden kaç satır etkilenirse etkilensin sadece bir kez çalışır.
        
    - **Satır Seviyesi (Row Level):** İşlemden etkilenen her bir satır için ayrı ayrı çalışır (`FOR EACH ROW` ile tanımlanır).
        
- **Sistem Triggerları:** Veritabanı (`STARTUP`, `SHUTDOWN`) veya şema olaylarına (`CREATE`, `DROP`, `ALTER`) bağlı çalışır.
    
- **Compound (Bütünleşik) Trigger:** Tek bir trigger bloğu içinde hem işlem öncesi/sonrası hem de satır bazlı işlemleri birleştiren yapıdır.
    
- **Instead Of Trigger:** Genellikle View'lar üzerinde, gerçekleşen işlemin yerine başka bir işlem yapmak için kullanılır.
    

### 3. Koşullu Predikatlar

Trigger gövdesinde hangi işlemin yapıldığını anlamak için kullanılır:

- `INSERTING`: Ekleme işlemi mi?
    
- `UPDATING`: Güncelleme işlemi mi?
    
- `DELETING`: Silme işlemi mi?
    

---

## BÖLÜM 2: İstisna İşleme (Exception Handling)

Programın çalışması sırasında meydana gelen hatalara (Runtime Errors) **istisna** denir. İstisnalar işlenmezse program aniden sonlanır ve veri tutarsızlığına yol açabilir.

### 1. İstisna İşleme Bloğu

Hataları yakalamak için `BEGIN ... END` bloğunun sonuna `EXCEPTION` kısmı eklenir.

- `WHEN hata_adi THEN ...` yapısı ile spesifik hatalar yakalanır.
    
- `WHEN OTHERS THEN ...` ile tanımlanmamış diğer tüm hatalar yakalanır.
    

### 2. İstisna Türleri

1. **Sistem İstisnaları (Oracle Tanımlı):**
    
    - **İsimli (Ön Tanımlı):** Sık karşılaşılan hatalardır. Örn: `NO_DATA_FOUND` (veri bulunamadı), `ZERO_DIVIDE` (sıfıra bölme hatası), `TOO_MANY_ROWS` (tek satır beklerken çok satır gelmesi).
        
    - **İsimsiz (Dahili):** Bir ismi olmayan, sadece hata kodu (ORA-xxxxx) olan hatalardır. `PRAGMA EXCEPTION_INIT` ile isim verilebilir veya `SQLCODE` ile yakalanabilir.
        
2. **Kullanıcı Tanımlı İstisnalar:** Programcının belirlediği iş kurallarına aykırı durumlarda (Örn: Stok miktarının negatife düşmesi) oluşturduğu istisnalardır.
    
    - Tanımlama: `hata_adi EXCEPTION;`
        
    - Fırlatma: `RAISE hata_adi;` veya `RAISE_APPLICATION_ERROR` kullanılır.
        

### 3. Hata Bilgisi Alma Fonksiyonları

- `SQLCODE`: Hatanın sayısal kodunu döndürür.
    
- `SQLERRM`: Hatanın açıklama mesajını döndürür.
    

---

## BÖLÜM 3: Pratik Kod Örnekleri

Aşağıda trigger ve istisna işleme konularını pekiştiren, doğru sözdizimi ile hazırlanmış örnekler yer almaktadır.

### Örnek 1: DML Trigger (Loglama İşlemi)

Bir çalışanın maaşı güncellendiğinde, eski ve yeni maaşı kaydeden bir trigger örneği.

```plsql
-- Trigger Tanımlama
CREATE OR REPLACE TRIGGER trg_maas_kontrol
AFTER UPDATE OF salary ON employees -- Sadece salary kolonu güncellenirse çalış
FOR EACH ROW -- Her satır için çalış (Eski ve yeni değerlere erişmek için)
BEGIN
    -- Maaş değiştiyse ekrana bilgi yaz (veya log tablosuna ekle)
    DBMS_OUTPUT.PUT_LINE('Eski Maaş: ' || :OLD.salary || 
                         ' - Yeni Maaş: ' || :NEW.salary);
END;
/
```

### Örnek 2: İstisna İşleme (Sıfıra Bölme ve Diğerleri)

Bir bölme işleminde olası hataları yakalayan blok.


```plsql
DECLARE
    v_bolunen NUMBER := 100;
    v_bolen   NUMBER := 0;
    v_sonuc   NUMBER;
BEGIN
    -- Bölme işlemi deneniyor
    v_sonuc := v_bolunen / v_bolen;
    DBMS_OUTPUT.PUT_LINE('Sonuç: ' || v_sonuc);

EXCEPTION
    -- Sıfıra bölme hatası yakalanırsa
    WHEN ZERO_DIVIDE THEN
        DBMS_OUTPUT.PUT_LINE('Hata: Bir sayı sıfıra bölünemez!');
    
    -- Beklenmeyen başka bir hata olursa
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Beklenmeyen Hata Kodu: ' || SQLCODE);
        DBMS_OUTPUT.PUT_LINE('Hata Mesajı: ' || SQLERRM);
END;
/
```

### Örnek 3: Kullanıcı Tanımlı İstisna

Bir çalışana negatif prim verilmesini engelleyen özel hata yönetimi.


```plsql
DECLARE
    v_prim_miktari NUMBER := -500;
    ex_gecersiz_prim EXCEPTION; -- Kullanıcı tanımlı istisna
BEGIN
    IF v_prim_miktari < 0 THEN
        -- Hata fırlatılır
        RAISE ex_gecersiz_prim;
    END IF;

    DBMS_OUTPUT.PUT_LINE('Prim tanımlandı: ' || v_prim_miktari);

EXCEPTION
    WHEN ex_gecersiz_prim THEN
        -- Özel hata mesajı verilir
        RAISE_APPLICATION_ERROR(-20001, 'Hata: Prim miktarı negatif olamaz!');
END;
/
```
